#####################DEP##############

###DEP for Quailtiy Contro
library("DEP")
library("dplyr")
library("tidyr")
library("purrr")
library("ggplot2")
library("SummarizedExperiment")
#Choosing protein groups text file generated by Maxquant analyzing  
proteinGroups <- read.table(file.choose(), sep="\t", header=TRUE)

data<-proteinGroups
data<-filter(data, Reverse!="+", Potential.contaminant!="+")
dim(data)
colnames(data)
data$Gene.names %>% duplicated() %>% any()
data %>% group_by(Gene.names) %>% summarize(frequency = n()) %>% 
  arrange(desc(frequency)) %>% filter(frequency > 1)
data_unique <- make_unique(data, "Gene.names", "Protein.IDs", delim = ";")
data$name %>% duplicated() %>% any()

LFQ_columns <- grep("LFQ.", colnames(data_unique)) 
experimental_design <- read.table(file.choose(),sep="\t",header=TRUE)
data_se <- make_se(data_unique, LFQ_columns, experimental_design)
LFQ_columns <- grep("LFQ.", colnames(data_unique))
data_se_parsed <- make_se_parse(data_unique, LFQ_columns)
data_se

##Visualization of results 
##Data frequency 
theme_DEP2()
plot_frequency(data_se, plot=TRUE)

##Number of proteins per sample
data_filt <- filter_missval(data_se, thr = 0)
data_filt2 <- filter_missval(data_se, thr = 1)
plot_numbers(data_filt, plot = TRUE)
plot_numbers(data_filt2, plot=TRUE)

##Protein coverage
plot_coverage(data_filt)

##Data Normalization
data_norm <- normalize_vsn(data_filt)
plot_normalization(data_filt, data_norm)

##Data missing value
plot_missval(data_filt)

##Density of missing value
plot_detect(data_filt)

##Imputation
impute(data_norm, fun = "") ##Wrong message 
data_imp <- impute(data_norm, fun = "MinProb", q = 0.01)
data_imp_man <- impute(data_norm, fun = "man", shift = 1.8, scale = 0.3)
data_imp_knn <- impute(data_norm, fun = "knn", rowmax = 0.9)
plot_imputation(data_norm, data_imp)
plot_imputation(data_norm, data_imp_man)
plot_imputation(data_norm, data_imp_knn)
#"bpca", "knn", "QRILC", "MLE", "MinDet", "MinProb", "man", "min", "zero", "mixed", "nbavg"


###Comparing conditions
data_diff <- test_diff(data_imp, type = "all", 
                       control = NULL,
                       design_formula = formula(~0 + condition))
data_diff_all_contrasts <- test_diff(data_imp, type = "all")
data_diff_manual <- test_diff(data_imp, type = "all", 
                              test = c("Soft_7.1", "Soft_6.8"))


###Comparing two conditions
dep <- add_rejections(data_diff, alpha = 0.05, lfc = log2(1.5))
dep2<-add_rejections(data_diff_all_contrasts, alpha = 0.05, lfc = log2(1.5))
dep3<-add_rejections(data_diff_manual, alpha = 0.05, lfc = log2(1.5))

###Plot PCA
plot_pca(dep, x = 1, y = 2, n = 1000, point_size = 5)
plot_pca(dep2, x = 1, y = 2, n = 1000, point_size = 5)
plot_pca(dep3, x = 1, y = 2, n = 1000, point_size = 5)

##Plot cor
plot_cor(dep, significant = TRUE, lower = -1, upper = 1, pal = "PRGn",
         plot=TRUE, pal_rev = FALSE)

##Plot Heatmaps
plot_heatmap(dep, type = "centered", kmeans = TRUE, 
             k = 6, col_limit = 6, show_row_names = TRUE,
             indicate = c("condition", "replicate"),
             clustering_distance = "euclidean")
plot_heatmap(dep, type = "contrast", kmeans = TRUE, 
             k = 6, col_limit = 6, show_row_names = FALSE,
             clustering_distance = "euclidean",
             indicate = c("condition", "replicate"))
plot_heatmap(dep, type = "centered", kmeans = TRUE, 
             k = 6, col_limit = 4, show_row_names = FALSE,
             indicate = c("condition", "replicate"))


#Plot volcano
plot_volcano(dep, contrast = "Soft_7.1_vs_Soft_6.8", 
             label_size =4, add_names = TRUE, plot=TRUE,
             adjusted = FALSE)

plot_volcano(dep, contrast = "Soft_7.1_vs_Soft_6.5", 
             label_size =2, add_names = TRUE, plot=TRUE,
             adjusted = TRUE)

plot_volcano(dep, contrast = "Soft_7.1_vs_Stiff_7.1", 
             label_size =2, add_names = TRUE, plot=TRUE,
             adjusted = TRUE)

plot_volcano(dep, contrast = "Soft_6.8_vs_Soft_6.5", 
             label_size =2, add_names = TRUE, plot=TRUE,
             adjusted = TRUE)

plot_volcano(dep, contrast = "Soft_6.8_vs_Stiff_6.8", 
             label_size =2, add_names = TRUE, plot=TRUE,
             adjusted = TRUE)

plot_volcano(dep, contrast = "Stiff_7.1_vs_Stiff_6.8", 
             label_size =2, add_names = TRUE, plot=TRUE,
             adjusted = TRUE)

plot_volcano(dep, contrast = "Stiff_7.1_vs_Stiff_6.5", 
             label_size =2, add_names = TRUE, plot=TRUE,
             adjusted = TRUE)

plot_volcano(dep, contrast = "Stiff_6.8_vs_Stiff_6.5", 
             label_size =2, add_names = TRUE, plot=TRUE,
             adjusted = TRUE)

##Single Protein
plot_single(dep, proteins = c("SPARC","COL5A1","COL2A1",
                              "COL1A2", "ADAM12","SLC7A1"), 
            type="centered")

## Plot conditions
plot_cond(dep) 

##Results

#data_results <- get_results(dep)
#data_results %>% filter(significant) %>% nrow()
#colnames(data_results)
#df_wide <- get_df_wide(dep)
#full_data <- data_results$dep
#plot_heatmap(full_data, type = "contrast", kmeans = TRUE, 
            # k = 6, col_limit = 4, show_row_names = FALSE)


#save(data_se, data_norm, data_imp, data_diff, dep, file = "data.RData")
#save(data_se, data_norm, data_imp, data_diff, dep, file = "data.csv")


results <- LFQ(data, experimental_design, 'MinProb', 'all', 'Soft_7.1')
report(results)
names(results)
results_table <-results$results
results_table %>% filter(significant) %>% nrow()
full_data <- results$dep
plot_heatmap(full_data, type = "contrast", kmeans = TRUE, 
             k = 6, col_limit = 4, show_row_names = TRUE)

plot_heatmap(full_data, type = "centered", kmeans = TRUE, 
             k = 6, col_limit = 4, show_row_names = TRUE)

write.csv(results_table,"ResultPvalue.csv")

results3<-get_results(dep)
colnames(results3)
significantproteins<-results[results3$significant]
nrow(significantproteins)
head(significantproteins)
report(significantproteins)

########################MQMETRICS###################

#BiocManager::install("MQmetrics")
library(MQmetrics)
tinytex::install_tinytex()

MQPathCombined <- system.file('extdata/combined1/', 
                              package = 'MQmetrics')

generateReport(MQPathCombined, output_dir = getwd(),
               name_output_file = "MQmetrics_report.pdf",
               remove_contaminants = TRUE,
               log_base = 2,
               long_names = FALSE,
               sep_names = NULL,intensity_type = "Intensity",
               palette = "Set2",
               UniprotID = NULL,
               segment_width = 1,
               show_shade = TRUE,
               percent_proteins = 0.9,
               show_calibrated_rt = FALSE,
               tolerance = 0.001,
               show_max_value = TRUE,
               peptides_modified = 1,
               show_median = TRUE,
               size_median = 1.5,
               binwidth = 0.1,
               plot_unmodified_peptides = FALSE,
               aggregate_PTMs = TRUE,
               combine_same_residue_ptms = TRUE,
               PTM_of_interest = "Oxidation (M)",
               plots_per_page = 5)

make_MQCombined(MQPathCombined, remove_contaminants = TRUE)
MQCombined<-make_MQCombined(MQPathCombined)
MaxQuantAnalysisInfo(MQCombined)

PlotProteinsIdentified(MQCombined)
PlotPeptidesIdentified(MQCombined)
PlotProteinPeptideRatio(MQCombined)
PlotMsMs(MQCombined)
PlotCharge(MQCombined)
PlotProteaseSpecificity(MQCombined)
PlotHydrophobicity(MQCombined, show_median =  TRUE)
PlotAndromedaScore(MQCombined, plots_per_page = 14)                 
PlotIntensity(MQCombined,palette = 'Set2',sep_names = '_',  split_violin_intensity = TRUE)
PlotPCA(MQCombined)
PlotCombinedDynamicRange(MQCombined,
                         show_shade = TRUE,
                         percent_proteins = 0.90)

PlotAllDynamicRange(MQCombined,
                    show_shade = TRUE, 
                    percent_proteins = 0.90)

PlotProteinOverlap(MQCombined)
PlotProteinCoverage(MQCombined)
PlotProteinCoverage(MQCombined,
                    UniprotID =  c('P55072', 'P13639'),
                    log_base = 2,
                    segment_width = 1,
                    palette = 'Set2',
                    plots_per_page = 14)

PlotTotalIonCurrent(MQCombined)

PlotAcquisitionCycle(MQCombined)



PlotPTM(MQCombined,
        peptides_modified = 1,
        plot_unmodified_peptides = FALSE,
        palette = 'Set2',
        aggregate_PTMs = TRUE,
        plots_per_page = 4)
PlotPTMAcrossSamples(MQCombined, 
                     PTM_of_interest = c('Acetyl (Protein N-term)',
                                         'Oxidation (M)'),
                     long_names = TRUE,
                     sep_names = '_')







####################
##Enrichment Analysis


